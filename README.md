# AstrBot Prompt Injector Plugin

这是一个 AstrBot 插件，允许用户为当前会话注入自定义的提示词（Prompt），包括“当前任务”和“附加知识”。这些注入的内容会自动添加到 LLM 的 System Prompt 中，并在指定轮次的对话内生效。

适用于需要让 AI 暂时扮演特定角色（如跑团主持人）、处理特定任务或基于特定背景知识进行对话的场景。

## 🌟 功能特性

*   **会话隔离**：每个群聊或私聊会话拥有独立的注入内容，互不干扰。
*   **两种注入类型**：
    *   `当前任务` (Task)：注入 AI 目前正在处理的任务描述。
    *   `附加知识` (Knowledge)：注入 AI 需要参考的背景知识。
*   **灵活的轮次控制**：
    *   支持指定注入内容生效的对话轮次（默认为 10 轮）。
    *   轮次耗尽后自动清除，避免污染后续对话。
*   **多条目支持**：支持同时注入多条任务或知识（受配置上限限制）。
*   **自定义模板**：可在配置中自定义注入到 System Prompt 的文本格式。
*   **白名单模式**：支持开启白名单模式，仅允许特定会话使用注入功能，防止滥用。

## ⚙️ 配置说明

在 AstrBot 管理面板的插件配置中，你可以设置以下选项：

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| `default_turns` | 整数 | `10` | 当用户未指定轮次时，注入内容默认生效的轮次。 |
| `max_turns_limit` | 整数 | `100` | 用户可以通过指令设置的最大轮次上限。 |
| `max_injections_per_session` | 整数 | `5` | 单个会话允许同时存在的最大注入条目数。 |
| `whitelist_mode` | 布尔值 | `false` | 是否开启白名单模式。开启后，只有白名单内的会话可用。 |
| `whitelist` | 列表 | `[]` | 允许使用功能的会话 ID (`unified_msg_origin`) 列表。 |
| `task_prompt_template` | 字符串 | `\n[Current Task]\n{content}\n` | 任务提示词的注入模板，需包含 `{content}` 占位符。 |
| `knowledge_prompt_template` | 字符串 | `\n[Additional Knowledge]\n{content}\n` | 知识提示词的注入模板，需包含 `{content}` 占位符。 |

## 💻 指令介绍

| 指令 | 参数格式 | 说明 |
| :--- | :--- | :--- |
| `/set_task` | `[轮次] <内容>` 或 `<内容> [轮次]` | 设置“当前任务”。例如：`/set_task 20 扮演猫娘` 或 `/set_task 扮演猫娘 20`。 |
| `/set_know` | `[轮次] <内容>` 或 `<内容> [轮次]` | 设置“附加知识”。例如：`/set_know 这里的货币是金币`。 |
| `/show_injections` | 无 | 查看当前会话所有生效的注入内容及剩余轮次。 |
| `/clear_injections` | 无 | 清除当前会话的所有注入内容。 |
| `/add_whitelist` | 无 | **(仅管理员)** 将当前会话加入白名单。 |

### 使用示例

**场景：让 AI 扮演跑团主持人**

1.  **注入任务（指定 20 轮生效）**：
    ```
    /set_task 20 你现在是一个跑团主持人，你需要根据我给出的剧情发展来写接下来的剧情。风格要克苏鲁一点。
    ```
    *AI 回复：✅ 当前任务已注入，将在 20 轮对话内生效。*

    *或者把轮次放在后面：*
    ```
    /set_task 你现在是一个跑团主持人... 20
    ```

2.  **注入背景知识（使用默认轮次）**：
    ```
    /set_know 现在的地点是在一所废弃的阿卡姆疯人院，时间是1920年。
    ```
    *AI 回复：✅ 附加知识已注入，将在 10 轮对话内生效。*

3.  **开始对话**：
    用户：我推开大门走了进去。
    AI：（基于注入的提示词生成剧情...）

4.  **查看状态**：
    ```
    /show_injections
    ```
    *AI 回复：*
    *📋 当前注入信息：*
    *1. 📌 任务 (剩 19 轮): 你现在是一个跑团主持人...*
    *2. 📚 知识 (剩 9 轮): 现在的地点是在一所废弃...*
    
5.  **结束扮演**：
    ```
    /clear_injections
    ```
